<script>
/* ---------- SAFETY CHECK ---------- */
if (!Array.isArray(WORDS) || WORDS.length === 0) {
  document.getElementById("hint").textContent = "ERROR: words not loaded";
  throw new Error("WORDS not loaded");
}

/* ---------- DAILY WORD (fixed for everyone) ---------- */
function getDailyWord() {
  const now = new Date();
  const hours = now.getUTCHours(); // UTC pour tous les joueurs
  const slot = hours >= 12 ? 1 : 0; // matin ou aprÃ¨s-midi
  const daySeed = Math.floor(now.getTime() / 86400000) * 2 + slot;

  // Liste alÃ©atoire mais stable pour 30 derniers mots
  const recent = JSON.parse(localStorage.getItem("themeWordleRecent")) || [];
  let index;
  do {
    index = Math.floor(daySeed % WORDS.length);
  } while (recent.slice(-30).includes(index));

  recent.push(index);
  if (recent.length > 30) recent.splice(0, recent.length - 30);
  localStorage.setItem("themeWordleRecent", JSON.stringify(recent));

  return WORDS[index];
}

const daily = getDailyWord();
const word = daily.word;
const theme = daily.theme;

/* ---------- UI ---------- */
const hint = document.getElementById("hint");
const board = document.getElementById("board");
const input = document.getElementById("input");
const validate = document.getElementById("validate");
const msg = document.getElementById("msg");
const copyBtn = document.getElementById("copy");

hint.textContent = `HINT: ${theme} â€¢ ${word.length} letters`;

/* ---------- GAME STATE ---------- */
const maxTries = 3;
let tries = 0;
let emojis = [];

/* ---------- BOARD ---------- */
for (let i = 0; i < maxTries; i++) {
  const row = document.createElement("div");
  row.className = "row";
  row.style.gridTemplateColumns = `repeat(${word.length},1fr)`;
  for (let j = 0; j < word.length; j++) {
    row.appendChild(document.createElement("div")).className = "cell";
  }
  board.appendChild(row);
}

/* ---------- STATS ---------- */
const statsKey = "themeWordleStats";
let stats = JSON.parse(localStorage.getItem(statsKey)) || {
  played:0, wins:0, streak:0, lastPlay:0
};

/* ---------- CHECK IF PLAYED ---------- */
const nowTime = Date.now();
const twelveHours = 12 * 60 * 60 * 1000;
const playedRecently = nowTime - stats.lastPlay < twelveHours;

if (playedRecently) {
  input.disabled = true;
  validate.disabled = true;
  msg.textContent = "ðŸ˜Ž You already played today. Share to a friend and come back in 12h.";
}

/* ---------- STATS DISPLAY ---------- */
function renderStats(){
  document.getElementById("played").textContent = stats.played;
  document.getElementById("wins").textContent = stats.wins;
  document.getElementById("streak").textContent = stats.streak;
  document.getElementById("rate").textContent =
    stats.played ? Math.round(stats.wins / stats.played * 100) : 0;
}
renderStats();

/* ---------- VALIDATE ---------- */
validate.onclick = () => {
  input.classList.remove("error");
  msg.textContent = "";

  const guess = input.value.toUpperCase().trim();
  if (guess.length !== word.length) {
    msg.textContent = "Wrong length";
    return;
  }

  const row = board.children[tries];

  [...row.children].forEach((cell,i)=>{
    cell.textContent = guess[i];
    if (guess[i] === word[i]) {
      cell.classList.add("correct"); 
    } else if (word.includes(guess[i])) {
      cell.classList.add("present"); 
    } else {
      cell.classList.add("absent"); 
    }
  });

  // Rouge uniquement sur input si mauvais mot
  if (guess !== word) {
    input.classList.add("error");
  } else {
    input.classList.add("correct");
  }

  let line = [...row.children].map(c => 
    c.classList.contains("correct") ? "ðŸŸ©" :
    c.classList.contains("present") ? "ðŸŸ¨" : "â¬›"
  ).join("");

  emojis.push(line);
  tries++;
  input.value = "";

  if (guess === word) endGame(true);
  else if (tries === maxTries) endGame(false);
};

/* ---------- END GAME ---------- */
function endGame(win){
  input.disabled = true;
  validate.disabled = true;
  copyBtn.classList.remove("hidden");

  stats.played++;
  stats.lastPlay = Date.now();
  if (win) {
    stats.wins++;
    stats.streak++;
    msg.textContent = "You win!";
  } else {
    stats.streak = 0;
    msg.textContent = `Word was: ${word}`;
  }

  localStorage.setItem(statsKey, JSON.stringify(stats));
  renderStats();
}

/* ---------- SHARE ---------- */
copyBtn.onclick = () => {
  navigator.clipboard.writeText(
    `Theme Wordle\n${emojis.join("\n")}`
  );
  msg.textContent = "Copied to clipboard!";
};

/* ---------- TIMER ---------- */
if (playedRecently) {
  const timerEl = document.createElement("div");
  timerEl.style.textAlign = "center";
  timerEl.style.marginTop = "8px";
  document.querySelector(".app").appendChild(timerEl);

  const updateTimer = () => {
    const diff = twelveHours - (Date.now() - stats.lastPlay);
    if (diff <= 0) {
      timerEl.textContent = "You can play now!";
      input.disabled = false;
      validate.disabled = false;
      input.classList.remove("error");
      clearInterval(timerInterval);
    } else {
      const h = Math.floor(diff / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      timerEl.textContent = `Next word in ${h}h ${m}m ${s}s`;
    }
  };
  const timerInterval = setInterval(updateTimer, 1000);
  updateTimer();
}
</script>
